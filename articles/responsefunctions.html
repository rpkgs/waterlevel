<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Response functions • waterlevel</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Response functions">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">waterlevel</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/responsefunctions.html">Response functions</a>
    </li>
    <li>
      <a href="../articles/staticbe.html">Static Barometric/Loading Efficiency Calculations</a>
    </li>
    <li>
      <a href="../articles/synthetic_example.html">Synthetic example</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Response functions</h1>
            
            <h4 data-toc-skip class="date">2025-09-07</h4>
      

      <div class="hidden name"><code>responsefunctions.Rmd</code></div>

    </div>

    
    
<p><img src="responsefunctions_files/figure-html/plotwl-1.png" width="700"><img src="responsefunctions_files/figure-html/plotwl-2.png" width="700"><img src="responsefunctions_files/figure-html/plotwl-3.png" width="700"></p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Response functions can provide a more complete picture than single
value methods that were presented in the <a href="staticbe.html">Static
BE vignette</a>. Static BE methods tend to be very simple to apply but
their interpretation and any derivative values determined from them
should be treated as rough estimates in all but the most ideal
circumstances. In the <a href="synthetic_example.html">Synthetic example
vignette</a> we fit barometric response functions for a synthetic
dataset with a known response function to test the efficiency of
different methods.</p>
<p>This vignette shows how to calculate the impulse response functions
(time domain) and frequency response functions (frequency domain) for
water levels, barometric pressure and Earth tides using field data.
Including terms for Earth tides is suggested for confined and
semi-confined aquifers so our examples will show how to easily include
them with the <em>earthtide</em> package.</p>
<hr>
<div class="section level3">
<h3 id="time-domain-barometric-response-function">Time domain barometric response function<a class="anchor" aria-label="anchor" href="#time-domain-barometric-response-function"></a>
</h3>
<p>We have decided to take the approach used in the <em>recipes</em>
package for the time being where we provide steps to build our dataset
to be used for linear regression. By building the dataset with a
<em>recipe</em>, it also allows for the user to easily specify the model
of choice. For our examples we will use the <em>lm</em> function to
determine the appropriate parameters. By the end of the time-domain
section we will have fit the data using the following methods:</p>
<ul>
<li>Lagged barometric response
<ul>
<li>Regular spaced <span class="citation">(Rasmussen and Crawford
1997)</span>
</li>
<li>Irregular spacing</li>
<li>Distributed lag</li>
</ul>
</li>
<li>Earth tides
<ul>
<li>Harmonic (specified frequencies) <span class="citation">(Rasmussen
and Mote 2007)</span>
</li>
<li>Theoretical
<ul>
<li>Lagged <span class="citation">(Toll and Rasmussen 2007)</span>
</li>
<li>Harmonic constituents <span class="citation">(Wenzel
1996)</span>
</li>
</ul>
</li>
</ul>
</li>
<li>Background trend (spline fit)</li>
<li>Level shifts</li>
</ul>
<hr>
<div class="section level4">
<h4 id="regular-and-irregular-spaced-lag-method">Regular and irregular spaced lag method<a class="anchor" aria-label="anchor" href="#regular-and-irregular-spaced-lag-method"></a>
</h4>
<p>Regular and irregular lag models can be specified in the same manner.
In this example we generate a set of regularly spaced lags using seq,
but they could be specified individually or with another function. We
find logarithmically spaced lags generated with <em>log_lags</em> can
work well to get good resolution at early times while still having a
parsimoneous model.</p>
<p>Monitoring interval: 2 minutes</p>
<p>Barometric lag range: 0 to 360 by 5</p>
<p>Earth tide lag range: 0 to 180 by 15</p>
<p>Natural spline fit for temporal trend with 31 degrees of freedom</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">delta_t</span> <span class="op">&lt;-</span> <span class="fl">120</span>                          <span class="co"># seconds</span></span>
<span></span>
<span><span class="va">max_lag_baro</span> <span class="op">&lt;-</span> <span class="fl">43200</span><span class="op">/</span><span class="va">delta_t</span>           <span class="co"># 0.5 days </span></span>
<span><span class="va">lag_baro_spacing</span> <span class="op">&lt;-</span> <span class="fl">2</span>                   <span class="co"># 4 minute between lags</span></span>
<span></span>
<span><span class="va">max_lag_et</span> <span class="op">&lt;-</span> <span class="fl">21600</span><span class="op">/</span><span class="va">delta_t</span>             <span class="co"># 0.25 days</span></span>
<span><span class="va">lag_et_spacing</span> <span class="op">&lt;-</span> <span class="fl">15</span>                    <span class="co"># 30 minutes between lags</span></span>
<span></span>
<span><span class="va">ns_df</span> <span class="op">&lt;-</span> <span class="fl">21</span>                             <span class="co"># natural spline with 21 terms</span></span>
<span></span>
<span><span class="va">ba_lags</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">max_lag_baro</span>, <span class="va">lag_baro_spacing</span><span class="op">)</span>   <span class="co"># barometric lag terms (reg)</span></span>
<span><span class="va">et_lags</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">max_lag_et</span>, <span class="va">lag_et_spacing</span><span class="op">)</span>       <span class="co"># earthtide lag terms  (reg)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="example-recipe">Example recipe:<a class="anchor" aria-label="anchor" href="#example-recipe"></a>
</h4>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">wl</span><span class="op">~</span><span class="va">.</span>, <span class="va">transducer</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                                           <span class="co">#1</span></span>
<span>  <span class="fu"><a href="../reference/step_lag_matrix.html">step_lag_matrix</a></span><span class="op">(</span><span class="va">baro</span>, lag <span class="op">=</span> <span class="va">ba_lags</span>, role <span class="op">=</span> <span class="st">'lag_matrix_baro'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>          <span class="co">#2</span></span>
<span>  <span class="fu"><a href="../reference/step_lag_matrix.html">step_lag_matrix</a></span><span class="op">(</span><span class="va">et</span>, lag <span class="op">=</span> <span class="va">et_lags</span>, role <span class="op">=</span> <span class="st">'lag_matrix_et'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>              <span class="co">#3</span></span>
<span>  <span class="fu">step_mutate</span><span class="op">(</span>datetime2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">datetime</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                           <span class="co">#4</span></span>
<span>  <span class="fu">step_ns</span><span class="op">(</span><span class="va">datetime2</span>, deg_free <span class="op">=</span> <span class="va">ns_df</span>, role <span class="op">=</span> <span class="st">'splines'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                  <span class="co">#5</span></span>
<span>  <span class="fu">prep</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                                                                  <span class="co">#6</span></span>
<span>  <span class="fu"><a href="../reference/portion.html">portion</a></span><span class="op">(</span><span class="op">)</span>                                                                   <span class="co">#7</span></span></code></pre></div>
<ol style="list-style-type: decimal">
<li>Take the transducer dataset, use <em>wl</em> as my dependent
variable</li>
<li>Lag the <em>baro</em> column to have a maximum lag of 0.5 day with 4
minute spacing</li>
<li>Lag the <em>et</em> column to have a maximum lag of 0.25 days with
30 minute spacing</li>
<li>Convert the datetime column from POSIXt to numeric (necessary for
step_ns)</li>
<li>Generate spline basis function regressors</li>
<li>Run the steps</li>
<li>Generate output for lm</li>
</ol>
<hr>
</div>
<div class="section level4">
<h4 id="fit-the-model">Fit the model:<a class="anchor" aria-label="anchor" href="#fit-the-model"></a>
</h4>
<p>We can fit the model with <em>lm</em> and the fitting method is the
same for each of the recipes so we will not repeat that code in the
following examples.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">~</span><span class="va">lag_matrix_baro</span> <span class="op">+</span> <span class="va">lag_matrix_et</span> <span class="op">+</span> <span class="va">splines</span>, <span class="va">dat</span>,      <span class="co"># fit model </span></span>
<span>          x <span class="op">=</span> <span class="cn">FALSE</span>, y <span class="op">=</span> <span class="cn">FALSE</span>, tol <span class="op">=</span> <span class="fl">1e-50</span>, </span>
<span>          na.action <span class="op">=</span> <span class="va">na.exclude</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">transducer</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>residuals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">)</span>         <span class="co"># add residuals</span></span>
<span></span>
<span><span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/response_from_fit.html">response_from_fit</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>                           <span class="co"># get the baro response</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/summarize_lm.html">summarize_lm</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">[</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'adj_r_squared'</span><span class="op">)</span>, with <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span><span class="co">#&gt;    variable                                                form n_obs n_coef</span></span>
<span><span class="co">#&gt;      &lt;char&gt;                                              &lt;char&gt; &lt;int&gt;  &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:       wl outcome ~ lag_matrix_baro + lag_matrix_et + splines 36361    216</span></span>
<span><span class="co">#&gt;       df        sigma r_squared       AIC           pivot has_intercept</span></span>
<span><span class="co">#&gt;    &lt;int&gt;        &lt;num&gt;     &lt;num&gt;     &lt;num&gt;          &lt;list&gt;        &lt;lgcl&gt;</span></span>
<span><span class="co">#&gt; 1: 36145 0.0003069872 0.9999527 -484821.4 1,2,3,4,5,6,...          TRUE</span></span>
<span><span class="co">#&gt;                              term_labels               coefs</span></span>
<span><span class="co">#&gt;                                   &lt;list&gt;              &lt;list&gt;</span></span>
<span><span class="co">#&gt; 1: lag_matrix_baro,lag_matrix_et,splines &lt;data.table[216x5]&gt;</span></span></code></pre></div>
<p><img src="responsefunctions_files/figure-html/solvesimpleplot-1.png" width="412.8"><img src="responsefunctions_files/figure-html/solvesimpleplot-2.png" width="412.8"></p>
<hr>
</div>
</div>
<div class="section level3">
<h3 id="distributed-lag-method">Distributed lag method<a class="anchor" aria-label="anchor" href="#distributed-lag-method"></a>
</h3>
<p>For this example we use <em>step_lag_distributed</em> instead of
<em>step_lag_matrix</em>. We then specify knots that are logaritmically
spaced using <em>log_lags</em>. This decreases the number of regressors
while still capturing early time behaviour. Results are visibly similar,
however, the distributed lag model is requires fewer regressors, is
faster to solve, and provides better early time resolution in this
example.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">knots</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/log_lags.html">log_lags</a></span><span class="op">(</span><span class="fl">15</span>, <span class="va">max_lag_baro</span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">wl</span><span class="op">~</span><span class="va">.</span>, <span class="va">transducer</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                          </span>
<span>  <span class="fu"><a href="../reference/step_distributed_lag.html">step_distributed_lag</a></span><span class="op">(</span><span class="va">baro</span>, knots <span class="op">=</span> <span class="va">knots</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>    </span>
<span>  <span class="fu"><a href="../reference/step_lag_matrix.html">step_lag_matrix</a></span><span class="op">(</span><span class="va">et</span>, lag <span class="op">=</span> <span class="va">et_lags</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>      </span>
<span>  <span class="fu">step_mutate</span><span class="op">(</span>datetime_num <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">datetime</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>           </span>
<span>  <span class="fu">step_ns</span><span class="op">(</span><span class="va">datetime_num</span>, deg_free <span class="op">=</span> <span class="va">ns_df</span>, role <span class="op">=</span> <span class="st">'splines'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                        </span>
<span>  <span class="fu">prep</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                                                 </span>
<span>  <span class="fu"><a href="../reference/portion.html">portion</a></span><span class="op">(</span><span class="op">)</span>                                                    </span></code></pre></div>
<pre><code><span><span class="co">#&gt;    variable                                             form n_obs n_coef    df</span></span>
<span><span class="co">#&gt;      &lt;char&gt;                                           &lt;char&gt; &lt;int&gt;  &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:       wl outcome ~ distributed_lag + lag_matrix + splines 36362     49 36313</span></span>
<span><span class="co">#&gt;           sigma r_squared       AIC           pivot has_intercept</span></span>
<span><span class="co">#&gt;           &lt;num&gt;     &lt;num&gt;     &lt;num&gt;          &lt;list&gt;        &lt;lgcl&gt;</span></span>
<span><span class="co">#&gt; 1: 0.0003061451 0.9999527 -485200.9 1,2,3,4,5,6,...          TRUE</span></span>
<span><span class="co">#&gt;                           term_labels              coefs</span></span>
<span><span class="co">#&gt;                                &lt;list&gt;             &lt;list&gt;</span></span>
<span><span class="co">#&gt; 1: distributed_lag,lag_matrix,splines &lt;data.table[49x5]&gt;</span></span></code></pre>
<p><img src="responsefunctions_files/figure-html/solvedistplot-1.png" width="412.8"><img src="responsefunctions_files/figure-html/solvedistplot-2.png" width="412.8"></p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="earth-tides">Earth tides<a class="anchor" aria-label="anchor" href="#earth-tides"></a>
</h2>
<p>In the previous two examples we used a lagged version of the
pre-computed Earth tide signal. We also have the option of directly
specifing the Earth tide calcuation in the recipe.</p>
<p>Three primary ways to do this as implemented in <em>waterlevel</em>
are:</p>
<ol style="list-style-type: decimal">
<li><p>Using a lagged form of the Earth tide signal. This method uses
the <em>earthtide</em> package to calculate a synthetic tide and lag the
result. For datasets of less than 14 days, this is the preferred method.
The problem is that the regression coefficients are not easily
interpreted, but for removing a signal they work well.</p></li>
<li><p>Calculate the Earth tide components for wave groups and use those
in the regression equation. This method uses the <em>earthtide</em>
package to calculate synthetic tidal constituents.</p></li>
<li><p>Generate cosine curves of different frequencies. For this method
the frequencies are specified in cycles per day and the appropriate sin
and cos curves used in regression are created.</p></li>
</ol>
<p>Here are example steps for the above three methods:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Method 1</span></span>
<span><span class="fu"><a href="../reference/step_lag_earthtide.html">step_lag_earthtide</a></span><span class="op">(</span><span class="va">datetime</span>,</span>
<span>                   lag <span class="op">=</span> <span class="va">et_lags</span>,</span>
<span>                   longitude <span class="op">=</span> <span class="op">-</span><span class="fl">118.67</span>,</span>
<span>                   latitude <span class="op">=</span> <span class="fl">34.23</span>,</span>
<span>                   elevation <span class="op">=</span> <span class="fl">550</span>,</span>
<span>                   wave_groups <span class="op">=</span> <span class="va">wave_groups</span>, </span>
<span>                   astro_update <span class="op">=</span> <span class="fl">60</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Method 2</span></span>
<span><span class="fu"><a href="../reference/step_earthtide.html">step_earthtide</a></span><span class="op">(</span><span class="va">datetime</span>,</span>
<span>               longitude <span class="op">=</span> <span class="op">-</span><span class="fl">118.67</span>,</span>
<span>               latitude <span class="op">=</span> <span class="fl">34.23</span>,</span>
<span>               elevation <span class="op">=</span> <span class="fl">550</span>,</span>
<span>               wave_groups <span class="op">=</span> <span class="va">wave_groups</span>, </span>
<span>               astro_update <span class="op">=</span> <span class="fl">60</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Method 3 with top 6 diurnal and semi-diurnal signals O1, K1, P1, N2, M2, S2</span></span>
<span><span class="fu"><a href="../reference/step_harmonic2.html">step_harmonic2</a></span><span class="op">(</span><span class="va">datetime</span>,</span>
<span>              freq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.9295357</span>, <span class="fl">0.9972621</span>, <span class="fl">1.0027379</span>, </span>
<span>                       <span class="fl">1.8959820</span>, <span class="fl">1.9322736</span>, <span class="fl">2.0000000</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<p>Let’s use our previous recipe for the distributed lag dataset but
instead use method 2 for Earth tides.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Select wavegroups</span></span>
<span><span class="va">wave_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="fu">earthtide</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/earthtide/man/eterna_wavegroups.html" class="external-link">eterna_wavegroups</a></span><span class="op">)</span></span>
<span><span class="va">wave_groups</span> <span class="op">&lt;-</span> <span class="va">wave_groups</span><span class="op">[</span><span class="va">start</span> <span class="op">&gt;</span> <span class="fl">0.5</span><span class="op">]</span></span>
<span><span class="va">wave_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">wave_groups</span><span class="op">[</span><span class="va">time</span> <span class="op">==</span> <span class="st">'1 month'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'start'</span>, <span class="st">'end'</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">knots</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/log_lags.html">log_lags</a></span><span class="op">(</span><span class="fl">15</span>, <span class="va">max_lag_baro</span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">wl</span><span class="op">~</span><span class="va">.</span>, <span class="va">transducer</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                          </span>
<span>  <span class="fu"><a href="../reference/step_distributed_lag.html">step_distributed_lag</a></span><span class="op">(</span><span class="va">baro</span>, knots <span class="op">=</span> <span class="va">knots</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>   </span>
<span>  <span class="fu"><a href="../reference/step_earthtide.html">step_earthtide</a></span><span class="op">(</span><span class="va">datetime</span>,</span>
<span>                 longitude <span class="op">=</span> <span class="op">-</span><span class="fl">118.67</span>,</span>
<span>                 latitude <span class="op">=</span> <span class="fl">34.23</span>,</span>
<span>                 elevation <span class="op">=</span> <span class="fl">550</span>,</span>
<span>                 wave_groups <span class="op">=</span> <span class="va">wave_groups</span>, </span>
<span>                 astro_update <span class="op">=</span> <span class="fl">60</span>,</span>
<span>                 scale <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>      </span>
<span>  <span class="fu">step_mutate</span><span class="op">(</span>datetime_num <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">datetime</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>           </span>
<span>  <span class="fu">step_ns</span><span class="op">(</span><span class="va">datetime_num</span>, deg_free <span class="op">=</span> <span class="va">ns_df</span>, role <span class="op">=</span> <span class="st">'splines'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                        </span>
<span>  <span class="fu">prep</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                                                 </span>
<span>  <span class="fu"><a href="../reference/portion.html">portion</a></span><span class="op">(</span><span class="op">)</span>                                                    </span></code></pre></div>
<pre><code><span><span class="co">#&gt;    variable                                            form n_obs n_coef    df</span></span>
<span><span class="co">#&gt;      &lt;char&gt;                                          &lt;char&gt; &lt;int&gt;  &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:       wl outcome ~ distributed_lag + earthtide + splines 36362     60 36302</span></span>
<span><span class="co">#&gt;           sigma r_squared     AIC           pivot has_intercept</span></span>
<span><span class="co">#&gt;           &lt;num&gt;     &lt;num&gt;   &lt;num&gt;          &lt;list&gt;        &lt;lgcl&gt;</span></span>
<span><span class="co">#&gt; 1: 0.0003014908 0.9999542 -486304 1,2,3,4,5,6,...          TRUE</span></span>
<span><span class="co">#&gt;                          term_labels              coefs</span></span>
<span><span class="co">#&gt;                               &lt;list&gt;             &lt;list&gt;</span></span>
<span><span class="co">#&gt; 1: distributed_lag,earthtide,splines &lt;data.table[60x5]&gt;</span></span></code></pre>
<p><img src="responsefunctions_files/figure-html/solveharm2-1.png" width="412.8"><img src="responsefunctions_files/figure-html/solveharm2-2.png" width="412.8"></p>
<p><img src="responsefunctions_files/figure-html/solveharmet-1.png" width="412.8"><img src="responsefunctions_files/figure-html/solveharmet-2.png" width="412.8"></p>
<p>The three models tend to perform similarly for this well. However, I
would choose the last model as it has the fewest, regressors, the lowest
residual standard error, and provides useful Earth tide amplitude and
phase information. This well had a generally small Earth tide component
and it is hardly visible in the original wl pressure time series,
however, we seem to be able achieve reasonable approximation of the
theoretical amplitudes.</p>
</div>
<div class="section level2">
<h2 id="frequency-domain-response-functions">Frequency domain response functions<a class="anchor" aria-label="anchor" href="#frequency-domain-response-functions"></a>
</h2>
<p>The following papers provide a good introduction to frequency
response functions and their applications to water levels <span class="citation">Hussein, Odling, and Clark (2013)</span>.</p>
<p>There are currently two ways to calculate the transfer function in
the <em>waterlevel</em> package. Using the default method which smooths
the periodogram, or using Welch’s method. See <em>spec_pgram</em> and
<em>spec_welch</em> for parameters. Often there is a lot of noise at
high frequencies. We plot Acworth’s method of static BE as a point in
each figure, which is fundamentally just the value of the transfer
function at 2 cycles per day (<span class="citation">Acworth et al.
(2016)</span>). These methods also output the phase and coherence, but
for the following plots we will stick to gain which can be thought of as
the loading efficiency as a function of frequency for these
examples.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">tf_pgram</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/transfer_fun.html">transfer_fun</a></span><span class="op">(</span><span class="va">transducer</span>,</span>
<span>                   vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'wl'</span>, <span class="st">'baro'</span>, <span class="st">'et'</span><span class="op">)</span>, </span>
<span>                   time <span class="op">=</span> <span class="st">'datetime'</span>, </span>
<span>                   method <span class="op">=</span> <span class="st">'spec_pgram'</span>,</span>
<span>                   spans <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="va">tf_welch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/transfer_fun.html">transfer_fun</a></span><span class="op">(</span><span class="va">transducer</span>,</span>
<span>                   vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'wl'</span>, <span class="st">'baro'</span>, <span class="st">'et'</span><span class="op">)</span>, </span>
<span>                   time <span class="op">=</span> <span class="st">'datetime'</span>, </span>
<span>                   method <span class="op">=</span> <span class="st">'spec_welch'</span>,</span>
<span>                   n_subsets <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Acworth BE</span></span>
<span><span class="va">be_a</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/be_acworth.html">be_acworth</a></span><span class="op">(</span><span class="va">transducer</span>, wl <span class="op">=</span> <span class="st">'wl'</span>, ba <span class="op">=</span> <span class="st">'baro'</span>, et <span class="op">=</span> <span class="st">'et'</span>, </span>
<span>                   inverse <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="responsefunctions_files/figure-html/frfplot-1.png" width="700"><img src="responsefunctions_files/figure-html/frfplot-2.png" width="700"></p>
<p>One way to decrease the noise is to use Konno-Ohmachi smoothing <span class="citation">(Konno and Ohmachi 1998)</span>. This method can be
slow for large datasets so we provide serial and parallel versions,
<em>konno_ohmachi_parallel</em>, <em>konno_ohmachi_serial</em>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">tf_pgram</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">tf_pgram</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>gain_wl_baro_smooth <span class="op">=</span> <span class="fu"><a href="../reference/konno_ohmachi_parallel.html">konno_ohmachi_parallel</a></span><span class="op">(</span><span class="va">tf_pgram</span><span class="op">$</span><span class="va">gain_wl_baro</span>, </span>
<span>                                                      <span class="va">tf_pgram</span><span class="op">$</span><span class="va">frequency</span>, </span>
<span>                                                      b <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tf_welch</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">tf_welch</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>gain_wl_baro_smooth <span class="op">=</span> <span class="fu"><a href="../reference/konno_ohmachi_parallel.html">konno_ohmachi_parallel</a></span><span class="op">(</span><span class="va">tf_welch</span><span class="op">$</span><span class="va">gain_wl_baro</span>, </span>
<span>                                                      <span class="va">tf_welch</span><span class="op">$</span><span class="va">frequency</span>, </span>
<span>                                                      b <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="responsefunctions_files/figure-html/frfsmoothplot-1.png" width="700"><img src="responsefunctions_files/figure-html/frfsmoothplot-2.png" width="700"></p>
<p>The frequency response methods are robust but often parameters may
need to be tuned for a particular study. In particular, when calculating
high frequency portions of spectra the Welch’s method with many subsets
can perform well.</p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Acworth2016" class="csl-entry">
Acworth, R. I., L. J. Halloran, G. C. Rau, M. O. Cuthbert, and T. L.
Bernardi. 2016. <span>“<span class="nocase">An objective frequency
domain method for quantifying confined aquifer compressible storage
using Earth and atmospheric tides</span>.”</span> <em>Geophysical
Research Letters</em> 43 (22): 11, 671–11, 678. <a href="https://doi.org/10.1002/2016GL071328" class="external-link">https://doi.org/10.1002/2016GL071328</a>.
</div>
<div id="ref-hussein2013borehole" class="csl-entry">
Hussein, Mahmoud EA, Noelle E Odling, and Roger A Clark. 2013.
<span>“Borehole Water Level Response to Barometric Pressure as an
Indicator of Aquifer Vulnerability.”</span> <em>Water Resources
Research</em> 49 (10): 7102–19.
</div>
<div id="ref-konno1998ground" class="csl-entry">
Konno, Katsuaki, and Tatsuo Ohmachi. 1998. <span>“Ground-Motion
Characteristics Estimated from Spectral Ratio Between Horizontal and
Vertical Components of Microtremor.”</span> <em>Bulletin of the
Seismological Society of America</em> 88 (1): 228–41.
</div>
<div id="ref-lai2013transfer" class="csl-entry">
Lai, Guijuan, Hongkui Ge, and Weilai Wang. 2013. <span>“Transfer
Functions of the Well-Aquifer Systems Response to Atmospheric Loading
and Earth Tide from Low to High-Frequency Band.”</span> <em>Journal of
Geophysical Research: Solid Earth</em> 118 (5): 1904–24.
</div>
<div id="ref-rasmussen1997identifying" class="csl-entry">
Rasmussen, Todd C, and Leslie A Crawford. 1997. <span>“Identifying and
Removing Barometric Pressure Effects in Confined and Unconfined
Aquifers.”</span> <em>Groundwater</em> 35 (3): 502–11.
</div>
<div id="ref-rasmussen2007monitoring" class="csl-entry">
Rasmussen, Todd C, and Thomas L Mote. 2007. <span>“Monitoring Surface
and Subsurface Water Storage Using Confined Aquifer Water Levels at the
Savannah River Site, USA.”</span> <em>Vadose Zone Journal</em> 6 (2):
327–35.
</div>
<div id="ref-rojstaczer1989influence" class="csl-entry">
Rojstaczer, Stuart, and Duncan Carr Agnew. 1989. <span>“The Influence of
Formation Material Properties on the Response of Water Levels in Wells
to Earth Tides and Atmospheric Loading.”</span> <em>Journal of
Geophysical Research: Solid Earth</em> 94 (B9): 12403–11.
</div>
<div id="ref-toll2007removal" class="csl-entry">
Toll, Nathanial J, and Todd C Rasmussen. 2007. <span>“Removal of
Barometric Pressure Effects and Earth Tides from Observed Water
Levels.”</span> <em>Groundwater</em> 45 (1): 101–5.
</div>
<div id="ref-wenzel1996nanogal" class="csl-entry">
Wenzel, Hans-Georg. 1996. <span>“The Nanogal Software: Earth Tide Data
Processing Package ETERNA 3.30.”</span> <em>Bull. Inf.
Mar<span>é</span>es Terrestres</em> 124: 9425–39.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jonathan Kennel.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
